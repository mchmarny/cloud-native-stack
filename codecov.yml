# Copyright (c) 2025, NVIDIA CORPORATION.  All rights reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

codecov:
  max_report_age: 12h

coverage:
  precision: 2
  round: nearest
  range: "60...90"

  status:
    # Overall project coverage
    project:
      default:
        target: auto      # Use coverage from base commit as target
        threshold: 1%     # Allow 1% drop before failing
        if_ci_failed: error

    # Coverage on changed files only
    patch:
      default:
        target: 70%       # New code should have 70% coverage
        threshold: 5%     # Allow 5% flexibility
        if_ci_failed: error

# PR comment configuration
comment:
  layout: "condensed_header, diff, flags, components"
  behavior: default
  require_changes: true
  require_base: true
  require_head: true
  hide_project_coverage: false

# GitHub Checks annotations (inline coverage feedback)
github_checks:
  annotations: true

# Ignore paths from coverage calculation
ignore:
  # Test files
  - "**/*_test.go"
  - "**/mock_*.go"
  - "**/mocks/**"
  - "**/testdata/**"
  - "**/fixtures/**"

  # Entry points (thin wrappers)
  - "cmd/**/main.go"

  # Non-code directories
  - "examples/**"
  - "docs/**"
  - "tools/**"
  - "deployments/**"
  - "pkg/recipe/data/**"

  # Templates (not Go code)
  - "**/*.tmpl"

# Component-based coverage tracking
component_management:
  default_rules:
    statuses:
      - type: project
        target: auto
        threshold: 2%
  individual_components:
    - component_id: bundler
      name: Bundlers
      paths:
        - pkg/bundler/**
    - component_id: components
      name: Components
      paths:
        - pkg/component/**
    - component_id: collector
      name: Collectors
      paths:
        - pkg/collector/**
    - component_id: recipe
      name: Recipes
      paths:
        - pkg/recipe/**
    - component_id: validator
      name: Validator
      paths:
        - pkg/validator/**
    - component_id: api
      name: API Server
      paths:
        - pkg/api/**
        - pkg/server/**
    - component_id: cli
      name: CLI
      paths:
        - pkg/cli/**

# Flag management for CI reporting
flags:
  unit:
    paths:
      - pkg/
    carryforward: true
    after_n_builds: 1
