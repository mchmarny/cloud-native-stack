# Copyright (c) 2025, NVIDIA CORPORATION.  All rights reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

name: 'Install E2E Testing Tools'
description: 'Installs ctlptl, kind, kubectl, and tilt for E2E testing'

runs:
  using: "composite"
  steps:
    - name: Load versions from .versions.yaml
      id: versions
      shell: bash
      run: |
        KIND_VERSION=$(yq eval '.testing_tools.kind' .versions.yaml)
        CTLPTL_VERSION=$(yq eval '.testing_tools.ctlptl' .versions.yaml)
        TILT_VERSION=$(yq eval '.testing_tools.tilt' .versions.yaml)
        KO_VERSION=$(yq eval '.build_tools.ko' .versions.yaml)
        echo "kind_version=${KIND_VERSION}" >> $GITHUB_OUTPUT
        echo "ctlptl_version=${CTLPTL_VERSION}" >> $GITHUB_OUTPUT
        echo "tilt_version=${TILT_VERSION}" >> $GITHUB_OUTPUT
        echo "ko_version=${KO_VERSION}" >> $GITHUB_OUTPUT

    - name: Cache E2E testing tools
      uses: actions/cache@5a3ec84eff668545956fd18022155c47e93e2684  # v4.2.3
      with:
        path: |
          /usr/local/bin/ctlptl
          /usr/local/bin/kind
          /usr/local/bin/kubectl
          /usr/local/bin/tilt
          /usr/local/bin/ko
        # yamllint disable-line rule:line-length
        key: e2e-${{ runner.os }}-${{ runner.arch }}-${{ hashFiles('.versions.yaml') }}
        restore-keys: |
          e2e-${{ runner.os }}-${{ runner.arch }}-

    - name: Install E2E testing tools
      shell: bash
      run: |
        # Install ctlptl (if not cached)
        CTLPTL_VERSION="${{ steps.versions.outputs.ctlptl_version }}"
        if command -v ctlptl &> /dev/null && ctlptl version | grep -q "v${CTLPTL_VERSION}"; then
          echo "ctlptl v${CTLPTL_VERSION} already installed"
        else
          echo "Installing ctlptl v${CTLPTL_VERSION}..."
          ARCH=$(case $(uname -m) in x86_64) echo x86_64;; aarch64|arm64) echo arm64;; *) echo $(uname -m);; esac)
          curl -fsSL https://github.com/tilt-dev/ctlptl/releases/download/v${CTLPTL_VERSION}/ctlptl.${CTLPTL_VERSION}.linux.${ARCH}.tar.gz | sudo tar -xzv -C /usr/local/bin ctlptl
        fi

        # Install Kind (if not cached)
        KIND_VERSION="${{ steps.versions.outputs.kind_version }}"
        if command -v kind &> /dev/null && kind version | grep -q "${KIND_VERSION}"; then
          echo "Kind v${KIND_VERSION} already installed"
        else
          echo "Installing Kind v${KIND_VERSION}..."
          ARCH=$(case $(uname -m) in x86_64) echo amd64;; aarch64|arm64) echo arm64;; *) echo $(uname -m);; esac)
          curl -fsSL -o ./kind https://kind.sigs.k8s.io/dl/v${KIND_VERSION}/kind-linux-${ARCH}
          chmod +x ./kind
          sudo mv ./kind /usr/local/bin/kind
        fi

        # Install kubectl (if not cached)
        if command -v kubectl &> /dev/null; then
          echo "kubectl already installed"
        else
          echo "Installing kubectl..."
          ARCH=$(case $(uname -m) in x86_64) echo amd64;; aarch64|arm64) echo arm64;; *) echo $(uname -m);; esac)
          curl -fsSL -O "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/${ARCH}/kubectl"
          chmod +x kubectl
          sudo mv ./kubectl /usr/local/bin/kubectl
        fi

        # Install Tilt (if not cached)
        TILT_VERSION="${{ steps.versions.outputs.tilt_version }}"
        if command -v tilt &> /dev/null && tilt version | grep -q "${TILT_VERSION}"; then
          echo "Tilt v${TILT_VERSION} already installed"
        else
          echo "Installing Tilt v${TILT_VERSION}..."
          ARCH=$(case $(uname -m) in x86_64) echo x86_64;; aarch64|arm64) echo arm64;; *) echo $(uname -m);; esac)
          curl -fsSL https://github.com/tilt-dev/tilt/releases/download/v${TILT_VERSION}/tilt.${TILT_VERSION}.linux.${ARCH}.tar.gz | sudo tar -xzv -C /usr/local/bin tilt
        fi

        # Install Ko (if not cached)
        KO_VERSION="${{ steps.versions.outputs.ko_version }}"
        # Strip leading 'v' if present for comparison
        KO_VERSION_NUM="${KO_VERSION#v}"
        if command -v ko &> /dev/null && ko version | grep -q "${KO_VERSION_NUM}"; then
          echo "Ko ${KO_VERSION} already installed"
        else
          echo "Installing Ko ${KO_VERSION}..."
          ARCH=$(case $(uname -m) in x86_64) echo x86_64;; aarch64|arm64) echo arm64;; *) echo $(uname -m);; esac)
          curl -fsSL https://github.com/ko-build/ko/releases/download/${KO_VERSION}/ko_${KO_VERSION_NUM}_Linux_${ARCH}.tar.gz | sudo tar -xzv -C /usr/local/bin ko
        fi

        # Verify installations
        echo "Verifying tool installations:"
        echo "ctlptl: $(ctlptl version)"
        echo "Kind: $(kind version)"
        echo "kubectl: $(kubectl version --client)"
        echo "Tilt: $(tilt version)"
        echo "Ko: $(ko version)"
        echo "Docker: $(docker version --format '{{.Client.Version}}')"
