# Copyright (c) 2025, NVIDIA CORPORATION.  All rights reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

name: 'Load Versions'
description: 'Loads tool versions from .versions.yaml (single source of truth)'

outputs:
  go:
    description: 'Go version'
    value: ${{ steps.versions.outputs.go }}
  goreleaser:
    description: 'GoReleaser version'
    value: ${{ steps.versions.outputs.goreleaser }}
  ko:
    description: 'Ko version'
    value: ${{ steps.versions.outputs.ko }}
  crane:
    description: 'Crane version'
    value: ${{ steps.versions.outputs.crane }}
  golangci_lint:
    description: 'golangci-lint version'
    value: ${{ steps.versions.outputs.golangci_lint }}
  addlicense:
    description: 'addlicense version'
    value: ${{ steps.versions.outputs.addlicense }}
  kind:
    description: 'Kind version'
    value: ${{ steps.versions.outputs.kind }}
  ctlptl:
    description: 'ctlptl version'
    value: ${{ steps.versions.outputs.ctlptl }}
  tilt:
    description: 'Tilt version'
    value: ${{ steps.versions.outputs.tilt }}
  helm:
    description: 'Helm version'
    value: ${{ steps.versions.outputs.helm }}

runs:
  using: 'composite'
  steps:
    - name: Load versions from .versions.yaml
      id: versions
      shell: bash
      run: |
        # Languages
        echo "go=$(yq eval '.languages.go' .versions.yaml)" >> $GITHUB_OUTPUT

        # Build tools
        echo "goreleaser=$(yq eval '.build_tools.goreleaser' .versions.yaml)" >> $GITHUB_OUTPUT
        echo "ko=$(yq eval '.build_tools.ko' .versions.yaml)" >> $GITHUB_OUTPUT
        echo "crane=$(yq eval '.build_tools.crane' .versions.yaml)" >> $GITHUB_OUTPUT

        # Linting
        echo "golangci_lint=$(yq eval '.linting.golangci_lint' .versions.yaml)" >> $GITHUB_OUTPUT
        echo "addlicense=$(yq eval '.linting.addlicense' .versions.yaml)" >> $GITHUB_OUTPUT

        # Testing tools
        echo "kind=$(yq eval '.testing_tools.kind' .versions.yaml)" >> $GITHUB_OUTPUT
        echo "ctlptl=$(yq eval '.testing_tools.ctlptl' .versions.yaml)" >> $GITHUB_OUTPUT
        echo "tilt=$(yq eval '.testing_tools.tilt' .versions.yaml)" >> $GITHUB_OUTPUT
        echo "helm=$(yq eval '.testing_tools.helm' .versions.yaml)" >> $GITHUB_OUTPUT

    - name: Display loaded versions
      shell: bash
      run: |
        echo "Loaded versions from .versions.yaml:"
        echo "  go: ${{ steps.versions.outputs.go }}"
        echo "  goreleaser: ${{ steps.versions.outputs.goreleaser }}"
        echo "  ko: ${{ steps.versions.outputs.ko }}"
        echo "  crane: ${{ steps.versions.outputs.crane }}"
        echo "  golangci_lint: ${{ steps.versions.outputs.golangci_lint }}"
        echo "  addlicense: ${{ steps.versions.outputs.addlicense }}"
        echo "  kind: ${{ steps.versions.outputs.kind }}"
        echo "  ctlptl: ${{ steps.versions.outputs.ctlptl }}"
        echo "  tilt: ${{ steps.versions.outputs.tilt }}"
        echo "  helm: ${{ steps.versions.outputs.helm }}"
