package result

import (
	"time"

	"github.com/NVIDIA/cloud-native-stack/pkg/bundler/types"
)

// Result contains the result of a single bundler execution.
type Result struct {
	// Type is the bundler type that generated this result.
	Type types.BundleType `json:"type" yaml:"type"`

	// Files is the list of files generated by this bundler.
	Files []string `json:"files" yaml:"files"`

	// Duration is the time taken to generate the bundle.
	Duration time.Duration `json:"duration" yaml:"duration"`

	// Size is the total size in bytes of all generated files.
	Size int64 `json:"size_bytes" yaml:"size_bytes"`

	// Checksum is the SHA256 checksum of the bundle contents.
	Checksum string `json:"checksum" yaml:"checksum"`

	// Errors contains non-fatal errors encountered during generation.
	Errors []string `json:"errors,omitempty" yaml:"errors,omitempty"`

	// Success indicates whether the bundler completed successfully.
	Success bool `json:"success" yaml:"success"`

	// OCI metadata (populated when --output-format=oci is used)

	// OCIDigest is the SHA256 digest of the pushed OCI artifact.
	OCIDigest string `json:"oci_digest,omitempty" yaml:"oci_digest,omitempty"`

	// OCIReference is the full image reference (registry/repository:tag).
	OCIReference string `json:"oci_reference,omitempty" yaml:"oci_reference,omitempty"`

	// Pushed indicates whether the bundle was pushed to an OCI registry.
	Pushed bool `json:"pushed,omitempty" yaml:"pushed,omitempty"`
}

// New creates a new Result with the given type.
func New(bundlerType types.BundleType) *Result {
	return &Result{
		Type:    bundlerType,
		Files:   make([]string, 0),
		Errors:  make([]string, 0),
		Success: false,
	}
}

// AddFile adds a file to the result and updates size.
func (r *Result) AddFile(path string, size int64) {
	r.Files = append(r.Files, path)
	r.Size += size
}

// AddError adds a non-fatal error to the result.
func (r *Result) AddError(err error) {
	if err != nil {
		r.Errors = append(r.Errors, err.Error())
	}
}

// MarkSuccess marks the bundle generation as successful.
func (r *Result) MarkSuccess() {
	r.Success = true
}

// GeneratedAt returns a formatted timestamp string.
func (r *Result) GeneratedAt() string {
	return time.Now().UTC().Format(time.RFC3339)
}

// SetOCIMetadata sets the OCI metadata on the result.
// The pushed parameter indicates whether the artifact was pushed to a remote registry.
func (r *Result) SetOCIMetadata(digest, reference string, pushed bool) {
	r.OCIDigest = digest
	r.OCIReference = reference
	r.Pushed = pushed
}
