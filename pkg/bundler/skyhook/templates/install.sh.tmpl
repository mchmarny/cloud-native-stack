#!/bin/bash
# Skyhook Operator Installation Script
# Generated by CNS Eidos
# Timestamp: {{ .Timestamp }}
# Bundler Version: {{ .Version }}

set -e

echo "Installing Skyhook Operator..."

# Create namespace if it doesn't exist
kubectl create namespace {{ .Namespace }} --dry-run=client -o yaml | kubectl apply -f -

# Add Helm repository
echo "Adding Skyhook Helm repository..."
helm repo add skyhook {{ .HelmChartRepo.Value }}
helm repo update

# Install Skyhook Operator
echo "Installing Skyhook Operator using Helm..."
helm upgrade --install {{ .HelmReleaseName.Value }} skyhook/{{ .HelmChartName.Value }} \
  --namespace {{ .Namespace }} \
  --create-namespace \
  --values values.yaml \
  --wait

# Wait for operator to be ready
echo "Waiting for Skyhook Operator to be ready..."
kubectl wait --for=condition=available --timeout=300s \
  deployment/skyhook-operator-controller-manager \
  -n {{ .Namespace }}

# Apply Skyhook CR
echo "Applying Skyhook custom resource..."
kubectl apply -f manifests/skyhook.yaml

echo "Skyhook Operator installation complete!"
echo ""
echo "To verify the installation:"
echo "  kubectl get pods -n {{ .Namespace }}"
echo "  kubectl get skyhook -A"
echo ""
echo "To view logs:"
echo "  kubectl logs -n {{ .Namespace }} -l control-plane=controller-manager"
