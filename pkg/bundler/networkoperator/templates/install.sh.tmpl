#!/bin/bash
# Network Operator Installation Script
# Generated from Cloud Native Stack Recipe
# Timestamp: {{ .Timestamp }}
# Bundler Version: {{ .Version }}
# Recipe Bundler Version: {{ .RecipeVersion }}

set -e

echo "========================================="
echo "Network Operator Installation"
echo "========================================="
echo ""

# Configuration
NAMESPACE="{{ .Namespace }}"
HELM_REPO="{{ .HelmRepository }}"
HELM_CHART="{{ .HelmChart }}"
{{- if .HelmChartVersion }}
CHART_VERSION="{{ .HelmChartVersion }}"
{{- end }}

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Helper functions
log_info() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# Check prerequisites
log_info "Checking prerequisites..."

if ! command -v kubectl &> /dev/null; then
    log_error "kubectl not found. Please install kubectl first."
    exit 1
fi

if ! command -v helm &> /dev/null; then
    log_error "helm not found. Please install Helm 3 first."
    exit 1
fi

# Check kubectl connectivity
if ! kubectl cluster-info &> /dev/null; then
    log_error "Cannot connect to Kubernetes cluster. Please check your kubeconfig."
    exit 1
fi

log_info "Prerequisites check passed."
echo ""

# Create namespace if it doesn't exist
log_info "Creating namespace ${NAMESPACE}..."
kubectl create namespace ${NAMESPACE} --dry-run=client -o yaml | kubectl apply -f -

# Add Helm repository
log_info "Adding Helm repository..."
helm repo add nvidia ${HELM_REPO}
helm repo update

# Install Network Operator
log_info "Installing Network Operator..."
{{- if .HelmChartVersion }}
helm install network-operator ${HELM_CHART} \
    --namespace ${NAMESPACE} \
    --version ${CHART_VERSION} \
    --values values.yaml \
    --create-namespace \
    --wait
{{- else }}
helm install network-operator ${HELM_CHART} \
    --namespace ${NAMESPACE} \
    --values values.yaml \
    --create-namespace \
    --wait
{{- end }}

echo ""
log_info "Network Operator installation initiated."

# Apply NicClusterPolicy
log_info "Applying NicClusterPolicy..."
kubectl apply -f manifests/nicclusterpolicy.yaml

echo ""
log_info "Waiting for Network Operator pods to be ready..."
kubectl wait --for=condition=ready pod \
    -l app.kubernetes.io/component=network-operator \
    -n ${NAMESPACE} \
    --timeout=300s

echo ""
echo "========================================="
log_info "Installation Complete!"
echo "========================================="
echo ""
echo "To check the status of Network Operator:"
echo "  kubectl get pods -n ${NAMESPACE}"
echo ""
echo "To view NicClusterPolicy:"
echo "  kubectl get nicclusterpolicy -n ${NAMESPACE}"
echo ""
{{- if .EnableRDMA }}
echo "RDMA is enabled. To verify RDMA devices:"
echo "  kubectl get nodes -o json | jq '.items[].status.allocatable'"
echo ""
{{- end }}
{{- if .EnableSRIOV }}
echo "SR-IOV is enabled. To verify SR-IOV devices:"
echo "  kubectl get sriovnetworknodestates -n ${NAMESPACE}"
echo ""
{{- end }}
