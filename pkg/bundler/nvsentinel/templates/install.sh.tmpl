#!/bin/bash
# NVSentinel Installation Script
# Generated by CNS Eidos
# Timestamp: {{ .Timestamp }}
# Bundler Version: {{ .Version }}

set -e

echo "Installing NVSentinel..."

# Create namespace if it doesn't exist
kubectl create namespace {{ .Namespace }} --dry-run=client -o yaml | kubectl apply -f -

# Install NVSentinel using Helm
echo "Installing NVSentinel {{ .NVSentinelVersion.Value }} using Helm..."
helm upgrade --install {{ .HelmReleaseName.Value }} {{ .HelmChartRepo.Value }} \
  --namespace {{ .Namespace }} \
  --create-namespace \
  --version {{ .NVSentinelVersion.Value }} \
  --timeout 15m \
  --wait

# Wait for NVSentinel pods to be ready
echo "Waiting for NVSentinel pods to be ready..."
kubectl wait --for=condition=ready --timeout=300s \
  pod -l app.kubernetes.io/name=nvsentinel \
  -n {{ .Namespace }} || true

echo "NVSentinel installation complete!"
echo ""
echo "To verify the installation:"
echo "  kubectl get pods -n {{ .Namespace }}"
echo "  kubectl get nodes  # Verify GPU nodes are visible"
echo ""
echo "To run validation:"
echo "  kubectl run nvsentinel-validation --image=curlimages/curl:latest -n {{ .Namespace }} --rm -it --restart=Never -- sh"
