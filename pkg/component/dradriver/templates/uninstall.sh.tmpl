#!/usr/bin/env bash

# DRA driver Uninstallation Script
# Generated from Cloud Native Stack Recipe
# Timestamp: {{ .Timestamp }}
# Bundler Version: {{ .Version }}
# Recipe Version: {{ .RecipeVersion }}

set -euo pipefail

NAMESPACE="{{ .Namespace }}"

log_info() {
    echo "[INFO] $1"
}

log_error() {
    echo "[ERROR] $1"
}

uninstall_dra_driver() {
    log_info "Uninstalling DRA driver..."
    
    if helm list -n "$NAMESPACE" | grep -q dra-driver; then
        helm uninstall dra-driver -n "$NAMESPACE" --wait
        log_info "DRA driver uninstalled."
    else
        log_info "DRA driver not found."
    fi
}

delete_manifests() {
    log_info "Deleting manifests..."
    
    # Delete all manifests (ConfigMaps and ClusterPolicy)
    if ls manifests/*.yaml &>/dev/null; then
        kubectl delete -f manifests/ -n "$NAMESPACE" --ignore-not-found=true
        log_info "Manifests deleted."
    fi
}

delete_crds() {
    log_info "Deleting CRDs..."
    log_info "CRDs deleted."
}

delete_namespace() {
    log_info "Deleting namespace: $NAMESPACE"
    kubectl delete namespace "$NAMESPACE" --ignore-not-found=true --wait
    log_info "Namespace deleted."
}

main() {
    log_info "Starting DRA driver uninstallation..."
    
    uninstall_dra_driver
    delete_manifests
    delete_crds
    
    read -p "Delete namespace $NAMESPACE? (y/N): " confirm
    if [[ "$confirm" == "y" || "$confirm" == "Y" ]]; then
        delete_namespace
    fi
    
    log_info "DRA driver uninstallation complete!"
}

main "$@"
