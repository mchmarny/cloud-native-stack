#!/usr/bin/env bash

# NVIDIA k8s DRA Driver Installation Script
# Generated from Cloud Native Stack Recipe
# Timestamp: {{ .Timestamp }}
# Bundler Version: {{ .Version }}
# Recipe Version: {{ .RecipeVersion }}

set -euo pipefail

# Configuration
NAMESPACE="{{ .Namespace }}"
HELM_REPO="{{ .HelmRepository }}"
HELM_CHART="{{ .HelmChart }}"
{{- if .HelmChartVersion }}
CHART_VERSION="{{ .HelmChartVersion }}"
{{- end }}

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

log_info() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

check_prerequisites() {
    log_info "Checking prerequisites..."
    
    if ! command -v kubectl &> /dev/null; then
        log_error "kubectl not found. Please install kubectl."
        exit 1
    fi
    
    if ! command -v helm &> /dev/null; then
        log_error "helm not found. Please install Helm 3."
        exit 1
    fi
    
    if ! kubectl cluster-info &> /dev/null; then
        log_error "Cannot connect to Kubernetes cluster."
        exit 1
    fi
    
    log_info "Prerequisites check passed."
}

create_namespace() {
    log_info "Creating namespace: $NAMESPACE"
    kubectl create namespace "$NAMESPACE" --dry-run=client -o yaml | kubectl apply -f -
}

add_helm_repo() {
    log_info "Adding Helm repository: $HELM_REPO"
    helm repo add nvidia "$HELM_REPO"
    helm repo update
}

apply_manifests() {
    log_info "Applying manifests..."
    
    # Apply all manifests
    if ls manifests/*.yaml &>/dev/null; then
        kubectl apply -f manifests/ -n "$NAMESPACE"
        log_info "Manifests applied."
    else
        log_warn "No manifests found in manifests/ directory."
    fi
}

install_dra_driver() {
    log_info "Installing DRA Driver..."
    
    helm upgrade --install dra-driver "$HELM_CHART" \
        --namespace "$NAMESPACE" \
        {{- if .HelmChartVersion }}
        --version "$CHART_VERSION" \
        {{- end }}
        --values values.yaml \
        --wait \
        --timeout 10m
    
    log_info "DRA driver installed successfully."
}

verify_installation() {
    log_info "Verifying installation..."
    
    kubectl wait --for=condition=ready pod \
        -l app=nvidia-dra-driver-gpu \
        -n "$NAMESPACE" \
        --timeout=600s || log_warn "DRA driver controller not ready yet"

    # Wait for kubelet plugin pods to be ready
    kubectl wait --for=condition=ready pod \
        -l app=nvidia-dra-driver-kubelet-daemonset \
        -n "$NAMESPACE" \
        --timeout=600s || log_warn "DRA driver kubelet pods not ready yet"
    
    log_info "Verification complete."
}

main() {
    log_info "Starting DRA driver installation..."
    
    check_prerequisites
    create_namespace
    add_helm_repo
    apply_manifests
    install_dra_driver
    verify_installation
    
    log_info "DRA driver installation complete!"
    log_info "Check status: kubectl get pods -n $NAMESPACE"
}

main "$@"
