# cert-manager Deployment Bundle

Generated from Cloud Native Stack Recipe  
Bundler Version: {{ .Script.Version }}  
Recipe Version: {{ .Script.RecipeVersion }}

## Overview

This bundle contains configuration files and scripts for deploying cert-manager to a Kubernetes cluster.

cert-manager is a cloud-native certificate management solution that automates the issuance and renewal of X.509 certificates from various sources including Let's Encrypt, HashiCorp Vault, Venafi, and more.

## Prerequisites

Before deploying cert-manager, ensure you have:

- Kubernetes 1.22+ cluster
- Helm 3.x installed
- kubectl configured with cluster access
- Appropriate RBAC permissions for:
  - Creating namespaces
  - Installing CRDs
  - Creating ClusterRoles and ClusterRoleBindings
  - Creating webhooks

### Optional (for ACME/Let's Encrypt):
- External DNS provider access (Route53, CloudFlare, Google Cloud DNS, etc.)
- Valid domain name for DNS-01 challenge
- SMTP server for email notifications

## Bundle Contents

- `values.yaml`: Helm chart configuration values
- `scripts/install.sh`: Automated installation script
- `scripts/uninstall.sh`: Cleanup script
- `README.md`: This documentation
- `checksums.txt`: SHA256 checksums for file integrity verification

## Configuration

### Namespace
{{- if .Helm.Namespace }}
Namespace: `{{ .Script.Namespace }}`
{{- end }}

### cert-manager Version
{{- if index .Values "version" }}
Version: `{{ index .Values "version" }}`
{{- end }}

### Configuration
{{- if index .Values "installCRDs" }}
- Install CRDs: {{ index .Values "installCRDs" }}
{{- end }}
{{- if index .Values "prometheus.enabled" }}
- Enable Prometheus: {{ index .Values "prometheus.enabled" }}
{{- end }}

### Resource Allocations
- Controller: {{ index .Values "controller.resources.requests.cpu" }} CPU / {{ index .Values "controller.resources.requests.memory" }} Memory
- Webhook: {{ index .Values "webhook.resources.requests.cpu" }} CPU / {{ index .Values "webhook.resources.requests.memory" }} Memory
- CA Injector: {{ index .Values "cainjector.resources.requests.cpu" }} CPU / {{ index .Values "cainjector.resources.requests.memory" }} Memory

### Node Placement
- Node Selector: {{ index .Values "nodeSelector" }}
- Toleration: {{ index .Values "tolerations" }}

## Installation

### Automated Installation

Use the provided installation script for a streamlined deployment:

```bash
chmod +x scripts/install.sh
./scripts/install.sh
```

The script will:
1. Check prerequisites (kubectl, helm)
2. Add Jetstack Helm repository
3. Create namespace (if needed)
4. Install cert-manager with configured values
5. Verify installation
6. Display next steps

### Manual Installation

If you prefer manual installation:

```bash
# Add Helm repository
helm repo add jetstack {{ .Script.HelmRepository }} --force-update
helm repo update

# Create namespace
kubectl create namespace {{ .Script.Namespace }}

# Install cert-manager
helm upgrade --install cert-manager {{ .Script.HelmChart }} \
  --namespace {{ .Script.Namespace }} \
  {{- if .Script.HelmChartVersion }}
  --version {{ .Script.HelmChartVersion }} \
  {{- end }}
  {{- if .Script.InstallCRDs }}
  --set installCRDs=true \
  {{- end }}
  --values values.yaml \
  --wait
```

## Verification

Verify the installation:

```bash
# Check pods
kubectl get pods -n {{ .Script.Namespace }}

# Check CRDs
kubectl get crd | grep cert-manager

# Wait for all components to be ready
kubectl wait --for=condition=ready pod \
  -l app.kubernetes.io/instance=cert-manager \
  -n {{ .Script.Namespace }} \
  --timeout=300s
```

Expected output should show:
- cert-manager controller pod (Running)
- cert-manager webhook pod (Running)
- cert-manager cainjector pod (Running)

## Usage Examples

### Create a ClusterIssuer (Let's Encrypt Production)

```yaml
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: letsencrypt-prod
spec:
  acme:
    server: https://acme-v02.api.letsencrypt.org/directory
    email: your-email@example.com
    privateKeySecretRef:
      name: letsencrypt-prod
    solvers:
    - http01:
        ingress:
          class: nginx
```

### Request a Certificate

```yaml
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: example-com
  namespace: default
spec:
  secretName: example-com-tls
  issuerRef:
    name: letsencrypt-prod
    kind: ClusterIssuer
  dnsNames:
  - example.com
  - www.example.com
```

### Use Certificate in Ingress

```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: example-ingress
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt-prod
spec:
  tls:
  - hosts:
    - example.com
    secretName: example-com-tls
  rules:
  - host: example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: example-service
            port:
              number: 80
```

## Monitoring

### Check Certificate Status

```bash
# List all certificates
kubectl get certificates -A

# Check specific certificate
kubectl describe certificate example-com -n default

# View certificate details
kubectl get secret example-com-tls -n default -o yaml
```

### View Logs

```bash
# Controller logs
kubectl logs -n {{ .Script.Namespace }} -l app=cert-manager

# Webhook logs
kubectl logs -n {{ .Script.Namespace }} -l app=webhook

# CA Injector logs
kubectl logs -n {{ .Script.Namespace }} -l app=cainjector
```

## Troubleshooting

### Certificate Not Being Issued

1. Check certificate status:
   ```bash
   kubectl describe certificate <name> -n <namespace>
   ```

2. Check certificate request:
   ```bash
   kubectl get certificaterequest -n <namespace>
   kubectl describe certificaterequest <name> -n <namespace>
   ```

3. Check order (for ACME):
   ```bash
   kubectl get orders -n <namespace>
   kubectl describe order <name> -n <namespace>
   ```

### Webhook Connection Issues

If you see webhook connection errors:

```bash
# Check webhook service
kubectl get svc -n {{ .Script.Namespace }}

# Check webhook pod
kubectl get pods -n {{ .Script.Namespace }} -l app=webhook

# Verify webhook configuration
kubectl get validatingwebhookconfiguration
kubectl get mutatingwebhookconfiguration
```

### Rate Limiting (Let's Encrypt)

Let's Encrypt has rate limits:
- 50 certificates per registered domain per week
- Use staging environment for testing: `https://acme-staging-v02.api.letsencrypt.org/directory`

## Uninstallation

### Automated Uninstallation

Use the provided uninstallation script:

```bash
chmod +x scripts/uninstall.sh
./scripts/uninstall.sh
```

The script will:
1. Confirm uninstallation
2. Delete custom resources (Certificates, Issuers)
3. Uninstall cert-manager Helm release
4. Delete CRDs
5. Optionally delete namespace and secrets

### Manual Uninstallation

```bash
# Delete custom resources
kubectl delete certificates --all --all-namespaces
kubectl delete issuers --all --all-namespaces
kubectl delete clusterissuers --all

# Uninstall Helm release
helm uninstall cert-manager -n {{ .Script.Namespace }}

# Delete CRDs
kubectl delete crd certificates.cert-manager.io
kubectl delete crd certificaterequests.cert-manager.io
kubectl delete crd issuers.cert-manager.io
kubectl delete crd clusterissuers.cert-manager.io
kubectl delete crd challenges.acme.cert-manager.io
kubectl delete crd orders.acme.cert-manager.io

# Delete namespace (optional)
kubectl delete namespace {{ .Script.Namespace }}
```

## Security Considerations

### RBAC
cert-manager requires cluster-wide permissions:
- ClusterRole for accessing CRDs
- ClusterRole for managing secrets
- ValidatingWebhookConfiguration
- MutatingWebhookConfiguration

### Network Policies
Consider implementing network policies to restrict:
- Ingress to webhook service
- Egress to ACME servers (Let's Encrypt)
- Access to certificate secrets

### Secret Storage
- Certificates are stored as Kubernetes Secrets
- Enable encryption at rest for etcd
- Use RBAC to restrict secret access
- Consider external secret stores (Vault, AWS Secrets Manager)

## Documentation

- [cert-manager Documentation](https://cert-manager.io/docs/)
- [ACME Issuers](https://cert-manager.io/docs/configuration/acme/)
- [Let's Encrypt Rate Limits](https://letsencrypt.org/docs/rate-limits/)
- [Troubleshooting Guide](https://cert-manager.io/docs/troubleshooting/)

## Support

For issues and questions:
- GitHub: https://github.com/cert-manager/cert-manager
- Slack: https://cert-manager.io/docs/contributing/#slack
- Documentation: https://cert-manager.io/docs/

---

Generated by Cloud Native Stack
