#!/usr/bin/env bash
# cert-manager Uninstallation Script
# Generated from Cloud Native Stack Recipe
# Timestamp: {{ .Timestamp }}
# Bundler Version: {{ .Version }}
# Recipe Version: {{ .RecipeVersion }}

set -euo pipefail

# Configuration
NAMESPACE="{{ .Namespace }}"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

log_info() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

confirm_uninstall() {
    log_warn "This will uninstall cert-manager and remove all certificates."
    log_warn "Custom resources (Certificates, Issuers) will also be deleted."
    read -p "Are you sure you want to continue? (yes/no): " -r
    if [[ ! $REPLY =~ ^[Yy]es$ ]]; then
        log_info "Uninstallation cancelled."
        exit 0
    fi
}

delete_custom_resources() {
    log_info "Deleting cert-manager custom resources..."
    
    # Delete Certificates
    if kubectl get certificates --all-namespaces &> /dev/null; then
        log_info "Deleting Certificates..."
        kubectl delete certificates --all --all-namespaces --ignore-not-found
    fi
    
    # Delete Issuers
    if kubectl get issuers --all-namespaces &> /dev/null; then
        log_info "Deleting Issuers..."
        kubectl delete issuers --all --all-namespaces --ignore-not-found
    fi
    
    # Delete ClusterIssuers
    if kubectl get clusterissuers &> /dev/null; then
        log_info "Deleting ClusterIssuers..."
        kubectl delete clusterissuers --all --ignore-not-found
    fi
    
    log_info "Custom resources deleted."
}

uninstall_cert_manager() {
    log_info "Uninstalling cert-manager..."
    
    if helm list -n ${NAMESPACE} | grep -q cert-manager; then
        helm uninstall cert-manager -n ${NAMESPACE} --wait
        log_info "cert-manager uninstalled successfully."
    else
        log_warn "cert-manager Helm release not found in namespace ${NAMESPACE}."
    fi
}

delete_crds() {
    log_info "Deleting cert-manager CRDs..."
    
    kubectl delete crd \
        certificates.cert-manager.io \
        certificaterequests.cert-manager.io \
        issuers.cert-manager.io \
        clusterissuers.cert-manager.io \
        challenges.acme.cert-manager.io \
        orders.acme.cert-manager.io \
        --ignore-not-found
    
    log_info "CRDs deleted."
}

delete_namespace() {
    log_warn "Deleting namespace ${NAMESPACE}..."
    read -p "Delete namespace ${NAMESPACE}? (yes/no): " -r
    if [[ $REPLY =~ ^[Yy]es$ ]]; then
        kubectl delete namespace ${NAMESPACE} --ignore-not-found
        log_info "Namespace deleted."
    else
        log_info "Namespace ${NAMESPACE} preserved."
    fi
}

cleanup_secrets() {
    log_info "Cleaning up certificate secrets..."
    
    # Find and optionally delete TLS secrets created by cert-manager
    log_warn "The following TLS secrets were created by cert-manager:"
    kubectl get secrets --all-namespaces -l cert-manager.io/certificate-name || true
    
    read -p "Delete these secrets? (yes/no): " -r
    if [[ $REPLY =~ ^[Yy]es$ ]]; then
        kubectl delete secrets --all-namespaces -l cert-manager.io/certificate-name --ignore-not-found
        log_info "Certificate secrets deleted."
    else
        log_info "Certificate secrets preserved."
    fi
}

main() {
    log_info "Starting cert-manager uninstallation..."
    
    confirm_uninstall
    delete_custom_resources
    uninstall_cert_manager
    delete_crds
    cleanup_secrets
    delete_namespace
    
    log_info "cert-manager uninstallation complete!"
}

main "$@"
