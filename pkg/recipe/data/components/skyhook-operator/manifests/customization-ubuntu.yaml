# Copyright (c) 2025, NVIDIA CORPORATION.  All rights reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# Skyhook Ubuntu Node Customization
# Generated by CNS - included via Helm umbrella chart
#
# This customization configures GPU nodes with:
# - GRUB parameters for hugepages and nokaslr
# - Containerd service limits
# - Sysctl kernel tuning parameters
{{- $skyhook := index .Values "skyhook-operator" }}
{{- if and $skyhook (eq (default "" $skyhook.customization) "ubuntu") }}
---
apiVersion: skyhook.nvidia.com/v1alpha1
kind: Skyhook
metadata:
  labels:
    app.kubernetes.io/part-of: skyhook-operator
    app.kubernetes.io/created-by: skyhook-operator
    app.kubernetes.io/managed-by: {{ .Release.Service }}
    helm.sh/chart: {{ .Chart.Name }}-{{ .Chart.Version }}
  name: ubuntu
  namespace: {{ .Release.Namespace }}
spec:
  runtimeRequired: true
  {{- if $skyhook.customizationTolerations }}
  additionalTolerations:
    {{- toYaml $skyhook.customizationTolerations | nindent 4 }}
  {{- else }}
  additionalTolerations:
    - key: dedicated
      operator: Exists
  {{- end }}
  interruptionBudget:
    percent: 100
  {{- if $skyhook.customizationNodeSelectors }}
  nodeSelectors:
    matchExpressions:
      {{- toYaml $skyhook.customizationNodeSelectors | nindent 6 }}
  {{- end }}
  packages:
    tuning:
      configInterrupts:
        grub.conf:
          type: reboot
        service_containerd.conf:
          type: service
          services: ["containerd"]
        sysctl.conf:
          type: reboot
      interrupt:
        type: reboot
      configMap:
        grub.conf: |-
          hugepagesz=1G
          hugepages=2
          hugepagesz=2M
          hugepages=5128
          nokaslr
        service_containerd.conf: |-
          [Service]
          LimitSTACK=67108864
        sysctl.conf: |-
          fs.inotify.max_user_instances=65535
          fs.inotify.max_user_watches=524288
          kernel.threads-max=16512444
          vm.max_map_count=262144
          vm.min_free_kbytes=65536
          vm.overcommit_memory=1
{{- end }}
