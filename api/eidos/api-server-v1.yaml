openapi: 3.1.0
info:
  title: Eidos API Server - CNS Recipe API
  version: 1.0.0
  description: >
    Returns optimized system configuration recipes (measurements and component recommendations)
    for a given combination of platform parameters (OS, kernel, service, Kubernetes, GPU, intent).
    
    The recipe system uses a rule-based overlay architecture where base measurements are layered
    with environment-specific overlays based on query matching.

servers:
  - url: https://api.eidos.dev/v1
    description: Production server
  - url: http://localhost:8080
    description: Local development server

tags:
  - name: Recipes
    description: Configuration recipe operations
  - name: Health
    description: Service health and readiness checks

paths:
  /v1/recipe:
    get:
      tags: [Recipes]
      summary: Get optimized system configuration recipe
      operationId: getRecipe
      description: >
        Returns a recipe containing measurements and configuration recommendations
        based on the provided query parameters. Uses rule-based overlay matching
        to combine base measurements with environment-specific configurations.
      parameters:
        - name: X-Request-Id
          in: header
          required: false
          schema:
            type: string
            format: uuid
          description: Client-provided request ID for tracing
        - name: os
          in: query
          required: false
          description: OS family. If omitted, treated as "any" (wildcard).
          schema:
            type: string
            enum: [ubuntu, cos, any]
            default: any
        - name: osv
          in: query
          required: false
          description: OS version (e.g., 24.04, 22.04). If omitted, treated as wildcard.
          schema:
            type: string
            pattern: '^\d+\.\d+(\.\d+)?$'
            examples: ["24.04", "22.04", "20.04"]
        - name: kernel
          in: query
          required: false
          description: Kernel version (e.g., 6.8, 5.15.0). Supports vendor suffixes. If omitted, treated as wildcard.
          schema:
            type: string
            pattern: '^\d+\.\d+(\.\d+)?'
            examples: ["6.8", "5.15.0", "6.8.0-1028-aws"]
        - name: service
          in: query
          required: false
          description: Kubernetes service/environment type. If omitted, treated as "any" (wildcard).
          schema:
            type: string
            enum: [eks, gke, aks, self-managed, any]
            default: any
        - name: k8s
          in: query
          required: false
          description: Kubernetes version (e.g., 1.33, v1.32.6). Supports vendor suffixes. If omitted, treated as wildcard.
          schema:
            type: string
            pattern: '^v?\d+\.\d+(\.\d+)?'
            examples: ["1.33", "v1.32.6", "v1.33.5-eks-3025e55"]
        - name: gpu
          in: query
          required: false
          description: GPU type. If omitted, treated as "any" (wildcard).
          schema:
            type: string
            enum: [h100, gb200, a100, l40, any]
            default: any
        - name: intent
          in: query
          required: false
          description: Workload intent. If omitted, treated as "any" (wildcard).
          schema:
            type: string
            enum: [training, inference, any]
            default: any
        - name: context
          in: query
          required: false
          description: Whether to include context metadata in measurements (true/false or 1/0)
          schema:
            type: string
            enum: ["true", "false", "1", "0"]
            default: "false"
      responses:
        "200":
          description: Recipe payload for the requested parameter combination
          headers:
            X-Request-Id:
              $ref: "#/components/headers/RequestIdResponse"
            Cache-Control:
              $ref: "#/components/headers/CacheControl"
            X-RateLimit-Limit:
              $ref: "#/components/headers/RateLimitLimit"
            X-RateLimit-Remaining:
              $ref: "#/components/headers/RateLimitRemaining"
            X-RateLimit-Reset:
              $ref: "#/components/headers/RateLimitReset"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RecipeResponse"
              examples:
                basic:
                  summary: Basic recipe request
                  value:
                    apiVersion: v1
                    kind: Recipe
                    request:
                      os: ubuntu
                      osv: "24.04"
                      service: eks
                      k8s: "1.33"
                      gpu: h100
                      intent: training
                    matchedRules:
                      - "OS: ubuntu any, Kernel: any, Service: eks, K8s: any, GPU: h100, Intent: training, Context: false"
                    measurements:
                      - type: systemd
                        subtypes:
                          - name: containerd.service
                            data:
                              CPUAccounting: "yes"
                              MemoryAccounting: "yes"
                      - type: os
                        subtypes:
                          - name: grub
                            data:
                              intel_iommu: "on"
                              iommu: "pt"
                      - type: k8s
                        subtypes:
                          - name: server
                            data:
                              version: "1.33.0"
                      - type: gpu
                        subtypes:
                          - name: device
                            data:
                              model: "H100"
        "400":
          description: Invalid request parameters
          headers:
            X-Request-Id:
              $ref: "#/components/headers/RequestIdResponse"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
              examples:
                invalidParameter:
                  summary: Invalid query parameter
                  value:
                    code: INVALID_REQUEST
                    message: "Invalid recipe query"
                    details:
                      error: "invalid os family: windows"
                    requestId: "550e8400-e29b-41d4-a716-446655440000"
                    timestamp: "2025-01-15T10:30:00Z"
                    retryable: false
        "429":
          description: Rate limit exceeded
          headers:
            Retry-After:
              schema:
                type: integer
              description: Seconds until retry allowed
            X-Request-Id:
              $ref: "#/components/headers/RequestIdResponse"
            X-RateLimit-Limit:
              $ref: "#/components/headers/RateLimitLimit"
            X-RateLimit-Remaining:
              $ref: "#/components/headers/RateLimitRemaining"
            X-RateLimit-Reset:
              $ref: "#/components/headers/RateLimitReset"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "500":
          description: Internal server error
          headers:
            X-Request-Id:
              $ref: "#/components/headers/RequestIdResponse"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
              examples:
                internalError:
                  summary: Server error during recipe build
                  value:
                    code: INTERNAL_ERROR
                    message: "Failed to build recipe"
                    details:
                      error: "failed to load recipe store"
                    requestId: "550e8400-e29b-41d4-a716-446655440000"
                    timestamp: "2025-01-15T10:30:00Z"
                    retryable: true
        "503":
          description: Service temporarily unavailable
          headers:
            Retry-After:
              schema:
                type: integer
              description: Seconds until retry allowed
            X-Request-Id:
              $ref: "#/components/headers/RequestIdResponse"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /health:
    get:
      tags: [Health]
      summary: Health check endpoint
      operationId: healthCheck
      description: Returns the health status of the service
      responses:
        "200":
          description: Service is healthy
          content:
            application/json:
              schema:
                type: object
                required: [status]
                properties:
                  status:
                    type: string
                    enum: [healthy]
                    example: healthy

  /ready:
    get:
      tags: [Health]
      summary: Readiness check endpoint
      operationId: readinessCheck
      description: Returns whether the service is ready to serve traffic
      responses:
        "200":
          description: Service is ready to serve traffic
          content:
            application/json:
              schema:
                type: object
                required: [status]
                properties:
                  status:
                    type: string
                    enum: [ready]
                    example: ready
        "503":
          description: Service is not ready
          content:
            application/json:
              schema:
                type: object
                required: [status]
                properties:
                  status:
                    type: string
                    enum: [not_ready]
                    example: not_ready
                  reason:
                    type: string
                    example: "initializing"

components:
  headers:
    RequestIdResponse:
      schema:
        type: string
        format: uuid
      description: Server-assigned or echoed request ID for tracing
    CacheControl:
      schema:
        type: string
      description: Cache directives for CDN/client caching
      example: "public, max-age=600"
    RateLimitLimit:
      schema:
        type: integer
      description: Request quota in current window
      example: 100
    RateLimitRemaining:
      schema:
        type: integer
      description: Remaining requests in current window
      example: 95
    RateLimitReset:
      schema:
        type: integer
      description: Unix timestamp when quota resets
      example: 1705318200

  schemas:
    Error:
      type: object
      required: [code, message, requestId, timestamp, retryable]
      properties:
        code:
          type: string
          description: Machine-readable error code
          examples:
            - INVALID_REQUEST
            - METHOD_NOT_ALLOWED
            - INTERNAL_ERROR
            - RATE_LIMIT_EXCEEDED
        message:
          type: string
          description: Human-readable error message
          example: "Invalid recipe query"
        details:
          type: object
          additionalProperties: true
          description: Additional context-specific error details
          nullable: true
        requestId:
          type: string
          format: uuid
          description: Unique request identifier for tracing
        timestamp:
          type: string
          format: date-time
          description: ISO 8601 timestamp when error occurred
        retryable:
          type: boolean
          description: Whether client should retry this request
          example: false

    Query:
      type: object
      description: Recipe query parameters
      properties:
        os:
          type: string
          description: Operating system family
          enum: [ubuntu, cos, any]
          example: ubuntu
        osv:
          type: string
          description: Operating system version
          example: "24.04"
        kernel:
          type: string
          description: Kernel version (supports vendor suffixes)
          example: "6.8.0-1028-aws"
        service:
          type: string
          description: Kubernetes service type
          enum: [eks, gke, aks, self-managed, any]
          example: eks
        k8s:
          type: string
          description: Kubernetes version (supports vendor suffixes)
          example: "v1.33.5-eks-3025e55"
        gpu:
          type: string
          description: GPU type
          enum: [h100, gb200, a100, l40, any]
          example: h100
        intent:
          type: string
          description: Workload intent
          enum: [training, inference, any]
          example: training
        withContext:
          type: boolean
          description: Include context metadata in measurements
          default: false

    Reading:
      type: object
      description: A single measurement reading with value and optional unit
      required: [value]
      properties:
        value:
          oneOf:
            - type: string
            - type: number
            - type: boolean
          description: The measurement value
        unit:
          type: string
          description: Optional unit of measurement
          example: "MB"

    Subtype:
      type: object
      description: A subtype within a measurement containing specific configuration data
      required: [name, data]
      properties:
        name:
          type: string
          description: Subtype identifier (e.g., service name, configuration category)
          example: containerd.service
        data:
          type: object
          additionalProperties:
            $ref: "#/components/schemas/Reading"
          description: Key-value pairs of configuration settings
        context:
          type: object
          additionalProperties: true
          description: Optional metadata about the source and collection method
          nullable: true

    Measurement:
      type: object
      description: A measurement grouping related configuration subtypes
      required: [type, subtypes]
      properties:
        type:
          type: string
          description: Measurement type category
          enum: [systemd, os, k8s, gpu]
          example: systemd
        subtypes:
          type: array
          items:
            $ref: "#/components/schemas/Subtype"
          description: List of configuration subtypes within this measurement

    RecipeResponse:
      type: object
      description: Complete recipe response with metadata and measurements
      required: [apiVersion, kind, measurements]
      properties:
        apiVersion:
          type: string
          description: API version of the recipe format
          example: v1
        kind:
          type: string
          description: Resource type
          enum: [Recipe]
          example: Recipe
        request:
          $ref: "#/components/schemas/Query"
          description: Original query parameters (omitted if all wildcards)
        matchedRules:
          type: array
          items:
            type: string
          description: List of overlay rules that matched this query
          example:
            - "OS: ubuntu any, Kernel: any, Service: eks, K8s: any, GPU: h100, Intent: training, Context: false"
        measurements:
          type: array
          items:
            $ref: "#/components/schemas/Measurement"
          description: System configuration measurements and recommendations
